<!--
DeepSeek AI Web Crawler - File Explorer
Copyright (c) 2025 Ayaz Mensyoğlu

This file is part of the DeepSeek AI Web Crawler project.
Licensed under the Apache License, Version 2.0.
See NOTICE file for additional terms and conditions.
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Explorer - DeepSeek AI Web Crawler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/file_explorer.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="header">
                <h1><i class="fas fa-folder-open"></i> File Explorer</h1>
                <p>Browse and download crawled files and PDFs</p>
            </div>

            <!-- Main Content -->
            <div class="content">
                <!-- Navigation Buttons -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <a href="/" class="btn home-btn">
                            <i class="fas fa-home"></i> Back to Web Crawler
                        </a>
                        {% if parent_path %}
                        <a href="/files/{{ parent_path }}" class="btn back-btn">
                            <i class="fas fa-arrow-up"></i> Go Up
                        </a>
                        {% endif %}
                    </div>
                    <div class="col-md-6 text-end">
                        {% if current_path == 'output' %}
                        <button class="btn btn-danger me-2" onclick="deleteAllItems()">
                            <i class="fas fa-trash"></i> Delete All
                        </button>
                        <button class="btn btn-primary" id="compressBtn" onclick="compressSelected()" disabled>
                            <i class="fas fa-archive"></i> Compress Selected Categories
                        </button>
                        {% else %}
                        <button class="btn btn-danger me-2" onclick="deleteAllItems()">
                            <i class="fas fa-trash"></i> Delete All
                        </button>
                        <a href="/download_output" class="btn btn-primary">
                            <i class="fas fa-download"></i> Download All as ZIP
                        </a>
                        {% endif %}
                    </div>
                </div>

                <!-- Breadcrumb Navigation -->
                <div class="breadcrumb">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item">
                                <a href="/files"><i class="fas fa-home"></i> Root</a>
                            </li>
                            {% if current_path %}
                                {% set path_parts = current_path.split('/') %}
                                {% for part in path_parts %}
                                    {% if loop.index == 1 %}
                                        <li class="breadcrumb-item">
                                            <a href="/files/{{ part }}">{{ part }}</a>
                                        </li>
                                    {% else %}
                                        {% set current_path_part = '/'.join(path_parts[:loop.index]) %}
                                        <li class="breadcrumb-item">
                                            <a href="/files/{{ current_path_part }}">{{ part }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </ol>
                    </nav>
                </div>

                <!-- Statistics -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number">{{ folders|length }}</div>
                            <div class="stats-label">Folders</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number">{{ files|length }}</div>
                            <div class="stats-label">Files</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number">{{ current_path.split('/')|length if current_path else 0 }}</div>
                            <div class="stats-label">Level Deep</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number">{{ current_path or 'Root' }}</div>
                            <div class="stats-label">Current Path</div>
                        </div>
                    </div>
                </div>

                <!-- Error Display -->
                {% if error %}
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Error:</strong> {{ error }}
                </div>
                {% endif %}

                <!-- File Explorer Table -->
                <div class="file-table">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                {% if current_path == 'output' %}
                                <th style="width: 50px;">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllCheckboxes()" title="Select all categories">
                                </th>
                                {% else %}
                                <th></th>
                                {% endif %}
                                <th>Name</th>
                                <th>Size</th>
                                <th>Modified</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Folders -->
                            {% for folder in folders %}
                            <tr>
                                {% if current_path == 'output' %}
                                <td>
                                    <input type="checkbox" class="category-checkbox" value="{{ folder.name }}" onchange="updateCompressButton()" title="Select {{ folder.name }} for compression">
                                </td>
                                {% else %}
                                <td>
                                    <i class="fas fa-folder folder-icon"></i>
                                </td>
                                {% endif %}
                                <td>
                                    <a href="/files/{{ folder.path }}" class="folder-link">
                                        {{ folder.name }}
                                    </a>
                                </td>
                                <td>{{ folder.size }}</td>
                                <td>{{ folder.modified }}</td>
                                <td>
                                    <a href="/files/{{ folder.path }}" class="btn btn-sm btn-outline-primary me-1">
                                        <i class="fas fa-folder-open"></i> Open
                                    </a>
                                    <button class="btn btn-sm btn-danger" onclick="deleteItem('{{ folder.path }}', '{{ folder.name }}', 'folder')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}

                            <!-- Files -->
                            {% for file in files %}
                            <tr>
                                <td>
                                    {% if file.name.lower().endswith('.pdf') %}
                                        <i class="fas fa-file-pdf pdf-icon"></i>
                                    {% else %}
                                        <i class="fas fa-file file-icon"></i>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="/files/{{ file.path }}" class="file-link" target="_blank">
                                        {{ file.name }}
                                    </a>
                                </td>
                                <td>{{ file.size }}</td>
                                <td>{{ file.modified }}</td>
                                <td>
                                    <a href="/files/{{ file.path }}" class="btn btn-sm btn-primary me-1" target="_blank">
                                        <i class="fas fa-download"></i> Download
                                    </a>
                                    <button class="btn btn-sm btn-danger" onclick="deleteItem('{{ file.path }}', '{{ file.name }}', 'file')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}

                            <!-- Empty State -->
                            {% if folders|length == 0 and files|length == 0 and not error %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="fas fa-folder-open fa-3x mb-3"></i>
                                    <p class="mb-0">This folder is empty</p>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Compression functionality
        function getSelectedCategories() {
            const checkboxes = document.querySelectorAll('.category-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function updateCompressButton() {
            const selected = getSelectedCategories();
            const compressBtn = document.getElementById('compressBtn');
            if (compressBtn) {
                compressBtn.disabled = selected.length === 0;
            }
        }

        function toggleAllCheckboxes() {
            const selectAll = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.category-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateCompressButton();
        }

        function compressSelected() {
            const selected = getSelectedCategories();
            
            if (selected.length === 0) {
                showAlert('Please select at least one category to compress.', 'warning');
                return;
            }

            const compressBtn = document.getElementById('compressBtn');
            const originalText = compressBtn.innerHTML;
            compressBtn.disabled = true;
            compressBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Compressing...';

            fetch('/compress_categories', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ categories: selected })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(`Successfully compressed ${selected.length} categor${selected.length > 1 ? 'ies' : 'y'}! <a href="${data.archive_url}" target="_blank">Download Archive</a>`, 'success');
                } else {
                    showAlert('Error: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                showAlert('Error compressing categories: ' + error.message, 'danger');
            })
            .finally(() => {
                compressBtn.disabled = false;
                compressBtn.innerHTML = originalText;
            });
        }

        // Delete functionality
        function deleteItem(path, name, type) {
            const itemType = type === 'folder' ? 'folder' : 'file';
            const confirmMessage = `Are you sure you want to delete this ${itemType}?\n\n${itemType === 'folder' ? 'This will delete the folder and ALL its contents permanently!' : 'This will delete the file permanently!'}\n\nName: ${name}`;
            
            if (confirm(confirmMessage)) {
                fetch('/delete_item', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        path: path
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        showAlert(data.message, 'success');
                        // Reload the page after a short delay
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        showAlert('Error: ' + data.error, 'danger');
                    }
                })
                .catch(error => {
                    showAlert('Error deleting item: ' + error.message, 'danger');
                });
            }
        }

        function deleteAllItems() {
            const confirmMessage = `⚠️  DANGER ZONE ⚠️ \n\nType 'DELETE ALL' to confirm:`;
            
            const userInput = prompt(confirmMessage);
            
            if (userInput === 'DELETE ALL') {
                // Delete all items by deleting the output folder contents
                fetch('/delete_item', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        path: '' // Empty path means root of output folder
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('All items deleted successfully!', 'success');
                        // Redirect to main page after deletion
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 2000);
                    } else {
                        showAlert('Error: ' + data.error, 'danger');
                    }
                })
                .catch(error => {
                    showAlert('Error deleting all items: ' + error.message, 'danger');
                });
            } else if (userInput !== null) {
                showAlert('Deletion cancelled. Type "DELETE ALL" exactly to confirm.', 'warning');
            }
        }

        function showAlert(message, type) {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <strong>${type === 'success' ? 'Success' : type === 'danger' ? 'Error' : type === 'warning' ? 'Warning' : 'Info'}:</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Add to page
            document.body.appendChild(alertDiv);
            
            // Auto-dismiss after 7 seconds for success messages with download links
            const dismissTime = message.includes('<a href') ? 7000 : 5000;
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, dismissTime);
        }
    </script>
</body>
</html>
