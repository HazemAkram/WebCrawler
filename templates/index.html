<!--
DeepSeek AI Web Crawler
Copyright (c) 2025 Ayaz MensyoÄŸlu

This file is part of the DeepSeek AI Web Crawler project.
Licensed under the Apache License, Version 2.0.
See NOTICE file for additional terms and conditions.
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek AI Web Crawler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1f2937;
            --light-color: #f9fafb;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
            max-width: 1200px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-weight: 700;
            font-size: 2.5rem;
        }

        .header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content {
            padding: 2rem;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1.5rem;
            font-weight: 600;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
        }

        .btn {
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #059669);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .progress {
            height: 25px;
            border-radius: 15px;
            background-color: #e5e7eb;
        }

        .progress-bar {
            background: linear-gradient(135deg, var(--success-color), #059669);
            border-radius: 15px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-running {
            background-color: var(--success-color);
            animation: pulse 2s infinite;
        }

        .status-stopped {
            background-color: var(--danger-color);
        }

        .status-idle {
            background-color: #6b7280;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: #1f2937;
            color: #f9fafb;
            border-radius: 10px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
        }

        .log-timestamp {
            color: #9ca3af;
        }

        .log-info { color: #60a5fa; }
        .log-success { color: #34d399; }
        .log-warning { color: #fbbf24; }
        .log-error { color: #f87171; }

        .file-upload-area {
            border: 3px dashed #d1d5db;
            border-radius: 15px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: var(--primary-color);
            background-color: rgba(99, 102, 241, 0.05);
        }

        .file-upload-area.dragover {
            border-color: var(--success-color);
            background-color: rgba(16, 185, 129, 0.1);
        }

        .stats-card {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stats-label {
            color: #6b7280;
            font-weight: 500;
        }

        .alert {
            border-radius: 10px;
            border: none;
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="header">
                <h1><i class="fas fa-spider"></i> DeepSeek AI Web Crawler</h1>
                <p>Intelligent web crawling with AI-powered data extraction</p>
            </div>

            <!-- Main Content -->
            <div class="content">
                <!-- File Upload Section -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-file-csv"></i> CSV File Upload
                    </div>
                    <div class="card-body">
                        <div class="file-upload-area" id="fileUploadArea">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5>Drop your CSV file here or click to browse</h5>
                            <p class="text-muted">The CSV should contain columns: url, css_selector, button_selector</p>
                            <input type="file" id="csvFile" accept=".csv" style="display: none;">
                            <button class="btn btn-outline-primary" onclick="document.getElementById('csvFile').click()">
                                <i class="fas fa-folder-open"></i> Choose File
                            </button>
                        </div>
                        <div id="fileInfo" class="mt-3" style="display: none;">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                <strong>File uploaded successfully!</strong>
                                <span id="fileName"></span>
                                <br>
                                <small>Total sites: <span id="totalSites"></span></small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuration Section -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-cog"></i> API Configuration
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="apiKey" class="form-label">API Key</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="apiKey" placeholder="Enter your API key">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()">
                                        <i class="fas fa-eye" id="eyeIcon"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    Supported providers: Groq, OpenAI, Anthropic
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="modelSelect" class="form-label">AI Model</label>
                                <select class="form-select" id="modelSelect">
                                    <option value="groq/deepseek-r1-distill-llama-70b">Groq - DeepSeek R1 Distill (70B)</option>
                                    <option value="groq/llama3-8b-8192">Groq - Llama3 8B</option>
                                    <option value="groq/llama3-70b-8192">Groq - Llama3 70B</option>
                                    <option value="groq/mixtral-8x7b-32768">Groq - Mixtral 8x7B</option>
                                    <option value="openai/gpt-4o">OpenAI - GPT-4o</option>
                                    <option value="openai/gpt-4o-mini">OpenAI - GPT-4o Mini</option>
                                    <option value="anthropic/claude-3-5-sonnet-20241022">Anthropic - Claude 3.5 Sonnet</option>
                                    <option value="anthropic/claude-3-haiku-20240307">Anthropic - Claude 3 Haiku</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PDF Settings Section -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-file-pdf"></i> PDF Download Settings
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="pdfSizeLimit" class="form-label">Maximum PDF Size (MB)</label>
                                <input type="number" class="form-control" id="pdfSizeLimit" 
                                       placeholder="10" min="1" max="100" value="10">
                                <div class="form-text">
                                    PDFs larger than this size will be skipped during download
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="skipLargeFiles" class="form-label">Skip Large Files</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="skipLargeFiles" checked>
                                    <label class="form-check-label" for="skipLargeFiles">
                                        Automatically skip files larger than the size limit
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Control Section -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-play-circle"></i> Crawling Controls
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-3">
                                    <span class="status-indicator" id="statusIndicator"></span>
                                    <span id="statusText">Ready to start</span>
                                </div>
                                <div class="progress mb-3" id="progressBar" style="display: none;">
                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-success me-2" id="startBtn" onclick="startCrawling()">
                                    <i class="fas fa-play"></i> Start Crawling
                                </button>
                                <button class="btn btn-danger" id="stopBtn" onclick="stopCrawling()" disabled>
                                    <i class="fas fa-stop"></i> Stop Crawling
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Section -->
                <div class="row" id="statsSection" style="display: none;">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="currentSite">0</div>
                            <div class="stats-label">Current Site</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="totalSitesStats">0</div>
                            <div class="stats-label">Total Sites</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="currentPage">1</div>
                            <div class="stats-label">Current Page</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="totalVenues">0</div>
                            <div class="stats-label">Total Products</div>
                        </div>
                    </div>
                </div>

                <!-- Logs Section -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-terminal"></i> Processing Logs
                        </div>
                        <div>
                            <a href="/files" class="btn btn-sm btn-success me-2" target="_blank">
                                <i class="fas fa-folder-open"></i> Browse Files
                            </a>
                            <button class="btn btn-sm btn-outline-primary" onclick="downloadOutput()">
                                <i class="fas fa-download"></i> Download Output
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
                                <i class="fas fa-trash"></i> Clear Logs
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="log-container" id="logContainer">
                            <div class="log-entry">
                                <span class="log-timestamp">[System]</span>
                                <span class="log-info">Web crawler interface ready. Upload a CSV file to begin.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let uploadedFile = null;
        let statusInterval = null;
        let isRunning = false;

        // File upload handling
        const fileUploadArea = document.getElementById('fileUploadArea');
        const csvFileInput = document.getElementById('csvFile');
        const fileInfo = document.getElementById('fileInfo');

        // Drag and drop functionality
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        csvFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        function handleFileUpload(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showAlert('Please select a CSV file.', 'danger');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    uploadedFile = data;
                    document.getElementById('fileName').textContent = data.filename;
                    document.getElementById('totalSites').textContent = data.total_sites;
                    fileInfo.style.display = 'block';
                    addLog('File uploaded successfully: ' + data.filename, 'success');
                } else {
                    showAlert(data.error, 'danger');
                }
            })
            .catch(error => {
                showAlert('Error uploading file: ' + error.message, 'danger');
            });
        }

        // Password toggle
        function togglePassword() {
            const apiKeyInput = document.getElementById('apiKey');
            const eyeIcon = document.getElementById('eyeIcon');
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                eyeIcon.className = 'fas fa-eye-slash';
            } else {
                apiKeyInput.type = 'password';
                eyeIcon.className = 'fas fa-eye';
            }
        }

        // Crawling controls
        function startCrawling() {
            if (!uploadedFile) {
                showAlert('Please upload a CSV file first.', 'warning');
                return;
            }

            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                showAlert('Please enter an API key.', 'warning');
                return;
            }

            const model = document.getElementById('modelSelect').value;
            const pdfSizeLimit = parseInt(document.getElementById('pdfSizeLimit').value) || 10;
            const skipLargeFiles = document.getElementById('skipLargeFiles').checked;

            fetch('/start_crawling', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    csv_filepath: uploadedFile.filepath,
                    api_key: apiKey,
                    model: model,
                    pdf_size_limit: pdfSizeLimit,
                    skip_large_files: skipLargeFiles
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isRunning = true;
                    updateStatus('running');
                    startStatusPolling();
                    addLog('Crawling started successfully', 'success');
                } else {
                    showAlert(data.error, 'danger');
                }
            })
            .catch(error => {
                showAlert('Error starting crawling: ' + error.message, 'danger');
            });
        }

        function stopCrawling() {
            fetch('/stop_crawling', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog('Stop request sent', 'warning');
                } else {
                    showAlert(data.error, 'danger');
                }
            })
            .catch(error => {
                showAlert('Error stopping crawling: ' + error.message, 'danger');
            });
        }

        // Status polling
        function startStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
            }
            
            statusInterval = setInterval(() => {
                fetch('/status')
                .then(response => response.json())
                .then(data => {
                    updateStatusDisplay(data);
                    
                    if (!data.is_running && isRunning) {
                        isRunning = false;
                        updateStatus('stopped');
                        clearInterval(statusInterval);
                        addLog('Crawling process finished', 'info');
                    }
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                });
            }, 1000);
        }

        function updateStatusDisplay(data) {
            // Update status indicator
            if (data.is_running) {
                updateStatus('running');
            } else if (data.stop_requested) {
                updateStatus('stopping');
            } else {
                updateStatus('stopped');
            }

            // Update statistics
            document.getElementById('currentSite').textContent = data.current_site;
            document.getElementById('totalSitesStats').textContent = data.total_sites;
            document.getElementById('currentPage').textContent = data.current_page;
            document.getElementById('totalVenues').textContent = data.total_venues;

            // Show stats section if crawling
            if (data.is_running || data.total_sites > 0) {
                document.getElementById('statsSection').style.display = 'block';
            }

            // Update progress bar
            if (data.total_sites > 0) {
                const progress = (data.current_site / data.total_sites) * 100;
                const progressBar = document.getElementById('progressBar');
                const progressBarInner = progressBar.querySelector('.progress-bar');
                
                progressBar.style.display = 'block';
                progressBarInner.style.width = progress + '%';
                progressBarInner.textContent = Math.round(progress) + '%';
            }

            // Update logs
            if (data.logs && data.logs.length > 0) {
                updateLogs(data.logs);
            }
        }

        function updateStatus(status) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');

            indicator.className = 'status-indicator';
            
            switch (status) {
                case 'running':
                    indicator.classList.add('status-running');
                    statusText.textContent = 'Crawling in progress...';
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    break;
                case 'stopping':
                    indicator.classList.add('status-warning');
                    statusText.textContent = 'Stopping...';
                    startBtn.disabled = true;
                    stopBtn.disabled = true;
                    break;
                case 'stopped':
                    indicator.classList.add('status-stopped');
                    statusText.textContent = 'Stopped';
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    break;
                default:
                    indicator.classList.add('status-idle');
                    statusText.textContent = 'Ready to start';
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
            }
        }

        // Logging functions
        function addLog(message, level = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-${level}">${message}</span>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateLogs(logs) {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '';
            
            logs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <span class="log-timestamp">[${log.timestamp}]</span>
                    <span class="log-${log.level.toLowerCase()}">${log.message}</span>
                `;
                logContainer.appendChild(logEntry);
            });
            
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = `
                <div class="log-entry">
                    <span class="log-timestamp">[System]</span>
                    <span class="log-info">Logs cleared.</span>
                </div>
            `;
        }

        // Utility functions
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.querySelector('.content').insertBefore(alertDiv, document.querySelector('.content').firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function downloadOutput() {
            window.open('/download_output', '_blank');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('idle');
        });
    </script>
</body>
</html> 